# ИИ-Управляемая Интеграция с CorpBonds.ru

## Обзор

Реализована интеллектуальная интеграция Инвеста с парсером corpbonds.ru, где ИИ сам принимает решения о необходимости запроса актуальных данных облигаций.

## Ключевые Изменения

### 1. Упрощенная Логика
- **Удалена** система ключевых слов для определения необходимости данных corpbonds.ru
- **Удалены** методы `_get_corpbonds_data_if_needed()` и `_determine_corpbonds_context()`
- **Удален** метод `_format_corpbonds_data()` из системного промпта

### 2. Function Calling
- **Добавлен** метод `_get_chatgpt_response_with_tools()` с поддержкой function calling
- **ИИ сам решает**, когда нужны данные corpbonds.ru
- **Автоматический выбор** контекста анализа (рейтинги, риски, доходность, ликвидность, финансовые показатели, полный анализ)

### 3. Интеллектуальное Поведение
- **Динамический запрос** данных только при необходимости
- **Контекстный анализ** вопросов пользователей
- **Fallback** к обычному ответу при ошибках
- **Более гибкое** и естественное взаимодействие

## Архитектура

```
Пользователь → Инвест → ИИ Анализ → Function Calling → CorpBonds.ru
                    ↓
                Автоматическое решение о необходимости данных
```

## Доступные Функции для ИИ

### get_corpbonds_data
- **Параметры:**
  - `isin`: ISIN облигации для анализа
  - `context`: Контекст анализа (рейтинги, риски, доходность, ликвидность, финансовые показатели, полный анализ)

- **Описание:** Получить актуальные данные облигаций с corpbonds.ru для анализа

## Примеры Использования

### Вопросы, которые вызовут запрос данных corpbonds.ru:
- "Какие рейтинги у моих облигаций?"
- "Расскажи про риски моих облигаций"
- "Какая доходность у облигаций в портфеле?"
- "Проанализируй мои облигации и дай рекомендации"
- "Расскажи про эмитентов моих облигаций"

### Вопросы, которые НЕ вызовут запрос данных:
- "Привет, как дела?"
- "Покажи мой портфель"
- "Как дела на рынке?"

## Преимущества

1. **Интеллектуальность**: ИИ сам определяет необходимость данных
2. **Гибкость**: Нет жестких правил и ключевых слов
3. **Эффективность**: Данные запрашиваются только при необходимости
4. **Надежность**: Fallback к обычному ответу при ошибках
5. **Естественность**: Более естественное взаимодействие с пользователем

## Тестирование

Создан тестовый скрипт `test_ai_driven_corpbonds.py` для проверки:
- Способности ИИ принимать решения о необходимости данных
- Качества ответов с использованием актуальных данных
- Правильности определения контекста анализа
- Интеллектуального поведения в различных сценариях

## Результаты Тестирования

✅ **Все тесты пройдены успешно**
- ИИ корректно определяет необходимость данных corpbonds.ru
- Function calling работает правильно
- Fallback к обычному ответу функционирует
- Качество ответов значительно улучшилось

## Заключение

ИИ-управляемый подход обеспечивает более интеллектуальное и гибкое взаимодействие с пользователями, позволяя Инвесту самостоятельно принимать решения о необходимости актуальных данных облигаций с corpbonds.ru.
