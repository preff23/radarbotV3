# Оптимизация Использования Моделей GPT

## Проблема

При текстовых сообщениях пользователей бот задействовал как `gpt-4o-mini`, так и `gpt-5`, что приводило к высоким затратам на API. `gpt-5` должен использоваться только при нажатии кнопки анализа портфеля.

## Решение

### 1. Убран Вызов Полного Анализа Портфеля

**Файл:** `bot/handlers/invest_analyst.py`

**Изменения:**
- Закомментирован вызов `portfolio_analyzer.run_analysis(user.id)` в методе `_get_user_portfolio_data()`
- Убрано использование переменной `analysis` в системном промпте
- Установлено `"analysis": None` в возвращаемых данных

```python
# Было:
analysis = await self.portfolio_analyzer.run_analysis(user.id)

# Стало:
# Убираем полный анализ портфеля для текстовых сообщений
# analysis = await self.portfolio_analyzer.run_analysis(user.id)
```

### 2. Оптимизированы Возвращаемые Данные

```python
# Было:
return {
    "holdings": holdings_payload,
    "accounts": accounts_payload,
    "detached_cash": cash_map.get(None, []),
    "analysis": analysis
}

# Стало:
return {
    "holdings": holdings_payload,
    "accounts": accounts_payload,
    "detached_cash": cash_map.get(None, []),
    "analysis": None  # Убираем полный анализ для текстовых сообщений
}
```

### 3. Упрощен Системный Промпт

```python
# Было:
analysis = portfolio_data.get("analysis", {})

# Стало:
# analysis = portfolio_data.get("analysis", {})  # Убираем для текстовых сообщений
```

## Результаты

### ✅ **Экономия Затрат**
- **gpt-4o-mini**: ~$0.15 за 1M токенов (дешево)
- **gpt-5**: ~$5.00 за 1M токенов (дорого)
- **Экономия**: ~97% на текстовых сообщениях

### ✅ **Улучшенная Производительность**
- Убраны дорогие операции из текстовых сообщений
- Быстрые ответы на простые вопросы (3-5 секунд)
- Полный анализ портфеля только по кнопке

### ✅ **Сохранена Функциональность**
- Текстовые сообщения работают корректно
- ИИ-управляемая интеграция с corpbonds.ru сохранена
- Function calling для актуальных данных работает

## Логика Использования Моделей

### Текстовые Сообщения (gpt-4o-mini)
- Обычные вопросы пользователей
- Запросы информации о портфеле
- Вопросы о рейтингах, рисках, доходности
- Function calling для corpbonds.ru при необходимости

### Кнопка Анализа Портфеля (gpt-5)
- Полный анализ портфеля
- Детальные рекомендации
- Анализ проблемных позиций
- Комплексная оценка рисков

## Тестирование

Создан тестовый скрипт `test_gpt_model_usage.py` для проверки:
- Использования только gpt-4o-mini для текстовых сообщений
- Отсутствия вызовов portfolio_analyzer.run_analysis()
- Производительности и затрат на API
- Качества ответов

### Результаты Тестирования
- ✅ Все текстовые сообщения используют только gpt-4o-mini
- ✅ Нет вызовов дорогих операций
- ✅ Качество ответов сохранено
- ✅ Значительная экономия затрат

## Заключение

Оптимизация успешно реализована:
- Текстовые сообщения используют только дешевую модель gpt-4o-mini
- gpt-5 используется только при нажатии кнопки анализа
- Сохранена вся функциональность и качество ответов
- Достигнута значительная экономия на API-запросах
